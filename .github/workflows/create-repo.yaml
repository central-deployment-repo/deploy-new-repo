name: Create Repository

on:
  issues:
    types: [opened]

jobs:
  deploy-repo:
    # Only run on issues with the deployment label
    if: contains(github.event.issue.labels.*.name, 'deployment')
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        
      - name: Parse issue
        id: parse-issue
        run: |
          # Extract information from the issue body
          echo "Issue title: ${{ github.event.issue.title }}"
          echo "Issue body: ${{ github.event.issue.body }}"
          
          # Parse the issue body to extract form data
          # This is a simplified parser - in a real scenario you might want to use a more robust solution
          ISSUE_BODY="${{ github.event.issue.body }}"
          
          # Extract repository name (this is a basic regex pattern)
          REPO_NAME=$(echo "$ISSUE_BODY" | grep -A 1 "Repository Name" | tail -1 | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
          
          # Extract organization (this is a basic regex pattern)  
          TARGET_ORG=$(echo "$ISSUE_BODY" | grep -A 1 "Target Organization" | tail -1 | sed 's/^[[:space:]]*//' | sed 's/[[:space:]]*$//')
          
          echo "Parsed repository name: $REPO_NAME"
          echo "Parsed target organization: $TARGET_ORG"
          
          # Set outputs for subsequent steps
          echo "repo-name=$REPO_NAME" >> $GITHUB_OUTPUT
          echo "target-org=$TARGET_ORG" >> $GITHUB_OUTPUT
          
      - name: Validate organization
        id: validate-org
        run: |
          # Read the Organizations.md file to validate the selected organization
          if [ -f "Organizations.md" ]; then
            VALID_ORGS=$(grep "^- " Organizations.md | sed 's/^- //')
            echo "Valid organizations:"
            echo "$VALID_ORGS"
            
            TARGET_ORG="${{ steps.parse-issue.outputs.target-org }}"
            
            if echo "$VALID_ORGS" | grep -q "^$TARGET_ORG$"; then
              echo "‚úÖ Organization '$TARGET_ORG' is valid"
              echo "valid=true" >> $GITHUB_OUTPUT
            else
              echo "‚ùå Organization '$TARGET_ORG' is not in the approved list"
              echo "valid=false" >> $GITHUB_OUTPUT
            fi
          else
            echo "‚ùå Organizations.md file not found"
            echo "valid=false" >> $GITHUB_OUTPUT
          fi
          
      - name: Deploy repository
        if: steps.validate-org.outputs.valid == 'true'
        id: deploy
        env:
          TARGET_ORG: ${{ steps.parse-issue.outputs.target-org }}
          REPO_NAME: ${{ steps.parse-issue.outputs.repo-name }}
          # Dynamic secret reference: <ORG>_SECRET (user will provision e.g. Some-org-9999_SECRET)
          ORG_TOKEN: ${{ secrets[CREATE_REPO] }}
        run: |
          set -euo pipefail
          echo "üöÄ Deploying repository '${REPO_NAME}' to organization '${TARGET_ORG}'"

          if [ -z "${ORG_TOKEN}" ]; then
            echo "‚ùå No secret found for organization '${TARGET_ORG}'. Expected secret named '${TARGET_ORG}_SECRET'"
            exit 1
          fi

          # Create repository via GitHub REST API
          # Using provided curl pattern; description kept minimal, can be extended to parse from issue later
          STATUS_CODE=$(curl -s -o response.json -w "%{http_code}" -L \
            -X POST \
            -H "Accept: application/vnd.github+json" \
            -H "Authorization: Bearer ${ORG_TOKEN}" \
            -H "X-GitHub-Api-Version: 2022-11-28" \
            "https://api.github.com/orgs/${TARGET_ORG}/repos" \
            -d "{\"name\":\"${REPO_NAME}\",\"description\":\"Repo created via automated deployment issue\",\"homepage\":\"https://github.com\",\"private\":true,\"has_issues\":true,\"has_projects\":true,\"has_wiki\":true}")

          echo "HTTP status: ${STATUS_CODE}"
          if [ "${STATUS_CODE}" -ge 300 ]; then
            echo "‚ùå Repository creation failed"
            echo "Response body:" && cat response.json
            exit 1
          fi

          echo "‚úÖ Repository deployment completed successfully"
          # Optionally extract full_name if jq exists
          if command -v jq >/dev/null 2>&1; then
            FULL_NAME=$(jq -r '.full_name // empty' response.json)
            if [ -n "$FULL_NAME" ]; then
              echo "created-full-name=$FULL_NAME" >> $GITHUB_OUTPUT
              echo "Created repository: $FULL_NAME"
            fi
          fi
          
      - name: Comment on issue - Success
        if: steps.validate-org.outputs.valid == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `üéâ **Repository deployment successful!**
              
              Repository: \`${{ steps.parse-issue.outputs.repo-name }}\`
              Organization: \`${{ steps.parse-issue.outputs.target-org }}\`
              
              The repository has been successfully deployed to the specified organization.`
            })
            
      - name: Comment on issue - Failure
        if: steps.validate-org.outputs.valid == 'false'
        uses: actions/github-script@v7
        with:
          script: |
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `‚ùå **Repository deployment failed!**
              
              The selected organization \`${{ steps.parse-issue.outputs.target-org }}\` is not in the approved list.
              
              Please check the [Organizations.md](./Organizations.md) file for valid organization options and update your issue accordingly.`
            })
            
      - name: Label issue
        uses: actions/github-script@v7
        with:
          script: |
            const label = ${{ steps.validate-org.outputs.valid == 'true' }} ? 'deployed' : 'deployment-failed';
            github.rest.issues.addLabels({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              labels: [label]
            })
